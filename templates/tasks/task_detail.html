{% extends 'base.html' %}
{% load custom_tags %}

{% block content %}

<style>
    .task-card, .comment-card {
        background: #fff;
        border-radius: 14px;
        padding: 22px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        transition: .3s;
    }
    .task-card:hover,
    .comment-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 26px rgba(0,0,0,0.15);
    }

    .comment-media img {
        width: 100%;
        border-radius: 10px;
        margin-top: 10px;
    }
    .comment-media video {
        width: 100%;
        border-radius: 10px;
        margin-top: 10px;
        max-height: 350px;
    }
    .comment-author {
        font-size: 0.9rem;
        color: #555;
    }
</style>

<div class="mx-auto" style="max-width: 900px;">

    <!-- –ë–õ–û–ö –ó–ê–í–î–ê–ù–ù–Ø -->
    <div class="task-card mb-4">

        <div class="d-flex justify-content-between align-items-start">
            <h2 class="fw-bold">{{ task.title }}</h2>

            <div class="d-flex gap-2">

                <!-- –†–ï–î–ê–ì–£–í–ê–¢–ò -->
                <a href="{% url 'tasks:task-update' task.id %}" class="btn btn-warning btn-sm">
                    ‚úè –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                </a>

                <!-- –í–ò–î–ê–õ–ò–¢–ò -->
                <a href="{% url 'tasks:task-delete' task.id %}" class="btn btn-danger btn-sm">
                    üóë –í–∏–¥–∞–ª–∏—Ç–∏
                </a>
            </div>
        </div>

        <p class="mt-3">{{ task.description }}</p>

        <div class="mt-2 d-flex gap-2">
            <span class="badge bg-primary">{{ task.status }}</span>
            <span class="badge bg-secondary">{{ task.priority }}</span>
        </div>

    </div>


    <!-- –ö–û–ú–ï–ù–¢–ê–†–Ü -->
    <h3 class="fw-bold mb-3">üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</h3>

    {% for comment in task.comments.all %}
    <div class="comment-card mb-3">

        <p class="mb-1">{{ comment.content }}</p>

        {% if comment.media %}
        <div class="comment-media">

            {% if comment.media.url|endswith:".jpg" or comment.media.url|endswith:".png" or comment.media.url|endswith:".jpeg" %}
                <img src="{{ comment.media.url }}" alt="–§–æ—Ç–æ">

            {% elif comment.media.url|endswith:".mp4" %}
                <video controls>
                    <source src="{{ comment.media.url }}" type="video/mp4">
                </video>

            {% else %}
                <a href="{{ comment.media.url }}" class="btn btn-outline-secondary btn-sm mt-2">
                    üìÅ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
                </a>
            {% endif %}

        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mt-3">

            <!-- –ê–≤—Ç–æ—Ä -->
            <small class="comment-author">–ê–≤—Ç–æ—Ä: {{ comment.author.username }}</small>

            <div class="d-flex gap-2">

                <!-- –õ–ê–ô–ö -->
                <form action="{% url 'tasks:comment-like-toggle' comment.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit"
                        class="btn btn-sm {% if request.user in comment.likes.all %}btn-success{% else %}btn-outline-success{% endif %}">
                        ‚ù§Ô∏è {{ comment.likes.count }}
                    </button>
                </form>

                <!-- –†–ï–î–ê–ì–£–í–ê–¢–ò –ö–û–ú–ï–ù–¢–ê–† -->
                <a href="{% url 'tasks:edit_comment' comment.id %}" class="btn btn-warning btn-sm">
                    ‚úè
                </a>

                <!-- –í–ò–î–ê–õ–ò–¢–ò –ö–û–ú–ï–ù–¢–ê–† -->
                <a href="{% url 'tasks:delete_comment' comment.id %}" class="btn btn-danger btn-sm">
                    üóë
                </a>

            </div>

        </div>

    </div>
    {% empty %}
    <div class="text-center py-4 bg-white rounded shadow-sm">
        <p class="text-muted mb-0">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>
    </div>
    {% endfor %}


    <!-- –î–û–î–ê–¢–ò –ö–û–ú–ï–ù–¢–ê–† -->
    <div class="comment-card mt-4">
        <h4 class="fw-bold mb-3">‚ûï –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä</h4>

        <form action="{% url 'tasks:task-detail' task.id %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="mb-3">
                {{ comment_form.content.label_tag }}
                {{ comment_form.content }}
            </div>

            <div class="mb-3">
                {{ comment_form.media.label_tag }}
                {{ comment_form.media }}
            </div>

            <button type="submit" class="btn btn-primary px-4">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </form>
    </div>

</div>

{% endblock %}
